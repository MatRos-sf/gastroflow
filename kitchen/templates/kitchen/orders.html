{% extends "menu/base.html" %}
{% block title %}
    Kitchen Orders
{% endblock title %}
{% block content %}
    <div class="container-fluid p-0">
        <!-- MENU TYLKO DLA KITCHEN -->
        <ul class="nav nav-tabs bg-dark rounded-0 border-0 px-2">
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'kitchen-orders' %}active bg-warning text-dark fw-bold{% else %}text-white{% endif %}"
                   href="{% url 'kitchen-orders' %}">Zamówienia</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'available' %}active bg-warning text-dark fw-bold{% else %}text-white{% endif %}"
                   href="{% url 'available' %}">Zmień status</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'orders-history-kitchen' %}active bg-warning text-dark fw-bold{% else %}text-white{% endif %}"
                   href="{% url 'orders-history' %}">Historia zamówień</a>
            </li>
        </ul>
        <!-- TREŚĆ -->
        <div class="container py-4">
            <h1 class="text-center text-dark mb-4">Kuchnia Zamówienia:</h1>
            <!-- FLEXBOX do kart -->
            <div id="orders-container" class="d-flex flex-wrap gap-3"></div>
        </div>
    </div>
    <style>
        /* Większa czcionka dla całej sekcji zamówień */
        #orders-container {
            font-size: 1.1rem; /* ~17-18px */
        }
        /* Szerokość kart i wyrównanie */
        .order-card {
            flex: 1 1 300px; /* min 300px, reszta dopasowana */
            max-width: 350px;
        }
        .card-header h5 {
            font-size: 1.25rem; /* większy tytuł */
        }
        .list-group-item {
            font-size: 1rem;
        }
    </style>
    <script>
        const ordersContainer = document.getElementById('orders-container');
        const kitchenSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/kitchen/orders/'
        );

        kitchenSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Message received:", data);

            if (data.type === 'initial_orders') {
                ordersContainer.innerHTML = '';
                data.orders.forEach(order => {
                    addOrderToView(order);
                });
            } else if (data.type === 'new_order') {
                const order = data.order;
                addOrderToView(order);
            } else if (data.type === 'order_status_update') {
                const orderId = data.order_id;
                const newStatus = data.new_status;

                if (newStatus.toLowerCase() === 'ready') {
                    const orderElement = document.getElementById(`order-${orderId}`);
                    if (orderElement) {
                        orderElement.remove();
                        console.log(`Order ${orderId} has been removed.`);
                    }
                } else {
                    const statusSpan = document.getElementById(`status-${orderId}`);
                    if (statusSpan) {
                        statusSpan.innerText = newStatus;
                        statusSpan.className = `badge bg-${getStatusClass(newStatus)}`;
                    }
                }
            }
        };

        kitchenSocket.onclose = function(e) {
            console.error('Kitchen socket closed unexpectedly');
        };

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'ordering':
                    return 'primary';
                case 'preparing':
                    return 'warning text-dark';
                case 'ready':
                    return 'success';
                default:
                    return 'secondary';
            }
        }

        function changeStatus(orderId, status) {
            kitchenSocket.send(JSON.stringify({
                'action': status,
                'order_id': orderId
            }));
        }

        function addOrderToView(order) {
            if (document.getElementById(`order-${order.id}`)) return;

            let orderItemsHtml = '';
            order.order_items.forEach(item => {
                orderItemsHtml += `
                    <li class="list-group-item" id="order-${order.id}-item-${item.id}" onclick="toggleItemDone(${order.id}, ${item.id}, '${order.sender}')">
                        ${item.name_snapshot} ×${item.quantity}
                        ${item.note ? `<small class="text-muted">(${item.note})</small>` : ''}
                    </li>
                `;
            });

            const orderElement = document.createElement('div');
            orderElement.id = `order-${order.id}`;
            orderElement.className = 'card mb-3 shadow-sm order-card';

            const statusClass = getStatusClass(order.status);

            orderElement.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Order #${order.id} @${order.sender}</h5>
                    <span id="status-${order.id}" class="badge bg-${statusClass}">${order.status}</span>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>Table:</strong> ${order.table}</p>
                    <p class="mb-2"><strong>Created At:</strong> ${order.last_update}</p>
                    <ul class="list-group mb-3">${orderItemsHtml}</ul>
                    <div class="d-flex gap-2">
                        <button class="btn btn-warning text-dark" onclick="changeStatus(${order.id}, 'preparing')">Preparing</button>
                        <button class="btn btn-success" onclick="changeStatus(${order.id}, 'ready')">Ready</button>
                    </div>
                </div>
            `;

            ordersContainer.append(orderElement);
        }
        function toggleItemDone(orderId, itemId, senderUsername) {
            const el = document.getElementById(`order-${orderId}-item-${itemId}`);
            el.classList.toggle('text-decoration-line-through');
            el.classList.toggle('text-muted');

            kitchenSocket.send(JSON.stringify({
                action: 'item_done',
                order_id: orderId,
                item_id: itemId,
                username: senderUsername
            }));
        }

    </script>
{% endblock content %}
