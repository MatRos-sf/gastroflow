{% extends "menu/base.html" %}
{% block content %}
    <style>
      .top-actions .btn { border-width: 2px; }
      .top-actions .btn.active,
      .top-actions .btn:focus,
      .top-actions .btn:active,
      .top-actions .btn.btn-outline-dark.active {
        background-color: #ffc107 !important;
        color: #212529 !important;
        border-color: #ffc107 !important;
      }

      .item-unavailable{ background-color: #dc3545; color: #fff; } /* danger  */

      .badge-contrast {
        background-color: rgba(255,255,255,.9);
        color: #212529;
      }
    </style>
    <div class="container mt-3">
        <div class="top-actions d-flex flex-wrap gap-2 flex-wrap justify-content-between">
            <a href="{% url 'kitchen-orders' %}"
               class="btn btn-outline-dark btn-lg ">Do Kuchni</a>
            <a href="{% url 'delivery-product' %}"
               class="btn bg-success btn-lg text-white ">Przywróć wszystko</a>
            <a href="{% url 'bar-orders' %}" class="btn btn-outline-dark btn-lg ">Do Baru</a>
        </div>
    </div>
    <div class="container mt-3">
        <h1 class="m-5 text-center">Zmień dostępność produktów</h1>
        <nav class="nav nav-pills flex-column flex-sm-row">
            {% for menu_type in menu_types %}
                <a class="flex-sm-fill text-sm-center nav-link {% if menu_type == request.GET.menu %}active{% endif %} border border-primary rounded m-1"
                   href="{% url 'available' %}?menu={{ menu_type }}">{{ menu_type|title }}</a>
            {% endfor %}
        </nav>
        <p class="mt-3 text-center">Kliknij w danie aby zmienić status</p>
    </div>
    <div class="container mt-4">
        <div class="list-group" id="items-list">
            {% for item in object_list %}
                <a href="#"
                   data-id="{{ item.id }}"
                   data-url="{% url 'toggle-availability' item.id %}"
                   class="list-group-item  d-flex justify-content-between align-items-center text-white {% if item.available == 1 %} bg-success {% elif item.available == 2 %} bg-warning {% else %} bg-danger {% endif %}"
                   role="button">
                    <span class="item-name fs-3 fw-semibold">{{ item.name }}</span>
                    <span class="badge badge-contrast">
                        {% if item.available == 1 %}
                            Dostępny
                        {% elif item.available == 2 %}
                            Mała ilości
                        {% else %}
                            Niedostępny
                        {% endif %}
                    </span>
                </a>
            {% empty %}
                <p class="text-muted">No items found.</p>
            {% endfor %}
        </div>
        <div class="text-muted mt-2" id="visible-count" style="display:none;"></div>
    </div>
    <script>
    (function() {
      // take csrf token from cookie
      function getCookie(name) {
        const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return v ? decodeURIComponent(v.split('=')[1]) : null;
      }

      const csrftoken = getCookie('csrftoken');

      // DOM - elements
      const list = document.getElementById('items-list');

      if (!list) return; // nic do roboty

      // Delegacja zdarzeń: lepsza skalowalność niż indywidualne nasłuchiwanie
      list.addEventListener('click', async function(e) {
        // Szukamy najbliższego .list-group-item (obsługuje kliknięcie wewnątrz elementu)
        const itemEl = e.target.closest('.list-group-item');
        if (!itemEl || !list.contains(itemEl)) return;

        // Zapobiegamy domyślnemu zachowaniu (<a href="#">) i wielokrotnym kliknięciom
        e.preventDefault();
        if (itemEl.dataset.busy === '1') return; // już trwa request
        itemEl.dataset.busy = '1'; // blokujemy kolejne kliknięcia aż do zakończenia

        const url = itemEl.dataset.url; // korzystamy z data-url w szablonie
        if (!url) {
          console.error('Brak data-url dla elementu', itemEl);
          itemEl.dataset.busy = '0';
          return;
        }

        // Opcjonalna drobna zmiana UI na czas oczekiwania (np. delikatne przyciemnienie)
        itemEl.style.opacity = '0.7';

        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json',
            },
          });

          if (!resp.ok) {
            // np. 403 (CSRF), 404, 500 itp.
            throw new Error('Network response was not ok (' + resp.status + ')');
          }

          const data = await resp.json();

          const badge = itemEl.querySelector('.badge');
          console.log(data);
          if (data && typeof data.available !== 'undefined') {
            if (data.available == 1) {
              itemEl.classList.remove('bg-danger');
              itemEl.classList.add('bg-success');
              if (badge) badge.textContent = 'Dostępny';
            } else if (data.available == 2){
              itemEl.classList.remove('bg-success');
              itemEl.classList.add('bg-warning');
              if (badge) badge.textContent = 'Mała ilość';
            } else {
              itemEl.classList.remove('bg-warning');
              itemEl.classList.add('bg-danger');
              if (badge) badge.textContent = 'Niedostępny';
            }
          } else {
            console.warn('Otrzymano nieoczekiwany format JSON:', data);
            alert('Nieprawidłowa odpowiedź z serwera.');
          }
        } catch (err) {
          console.error('Błąd przy toggle availability:', err);
          alert('Wystąpił błąd podczas zmiany dostępności. Spróbuj ponownie.');
        } finally {
          // przywracamy UI i odblokowujemy element
          itemEl.style.opacity = '';
          itemEl.dataset.busy = '0';
        }
      });
    })();
    </script>
{% endblock content %}
